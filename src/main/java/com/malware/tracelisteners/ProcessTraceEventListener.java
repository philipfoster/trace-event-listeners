package com.malware.tracelisteners;


import com.malware.tracelisteners.events.ProcessTraceEvent;
import com.malware.tracelisteners.events.ProcessTraceEventType;
import com.malware.tracelisteners.events.TraceEventType;
import com.malware.tracelisteners.messaging.AmqMessagePublisher;
import com.malware.tracelisteners.messaging.MessagePublisher;
import com.malware.tracelisteners.messaging.PublishingFailedException;
import com.malware.tracelisteners.model.Node;
import com.malware.tracelisteners.model.NodeState;
import com.malware.tracelisteners.model.Process;
import java.time.LocalDateTime;
import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;
import org.kie.api.event.process.ProcessCompletedEvent;
import org.kie.api.event.process.ProcessEventListener;
import org.kie.api.event.process.ProcessNodeLeftEvent;
import org.kie.api.event.process.ProcessNodeTriggeredEvent;
import org.kie.api.event.process.ProcessStartedEvent;
import org.kie.api.event.process.ProcessVariableChangedEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ProcessTraceEventListener implements ProcessEventListener {
    protected static final Logger LOGGER = LoggerFactory.getLogger(ProcessTraceEventListener.class);
    private MessagePublisher publisher;
    private LocalDateTime nodeStartTime;

    public ProcessTraceEventListener() throws Exception {
        publisher = new AmqMessagePublisher();
    }

    public void beforeNodeTriggered(ProcessNodeTriggeredEvent event) {
        LOGGER.trace("BeforeNodeTriggered: " + event.toString());
        nodeStartTime = LocalDateTime.now();
    }

    public void beforeProcessStarted(ProcessStartedEvent event) {
        LOGGER.trace("BeforeProcessStarted: " + event.toString());

        RuleFlowProcessInstance rfpi = (RuleFlowProcessInstance) event.getProcessInstance();

        String id = Long.toString(rfpi.getId());

        ProcessTraceEvent processTraceEvent = new ProcessTraceEvent();
        processTraceEvent.setEventType(TraceEventType.ProcessTraceEvent);
        processTraceEvent.setTimeStamp(LocalDateTime.now());
        processTraceEvent.setType(ProcessTraceEventType.BeforeProcessStarted);
        processTraceEvent.setProcessInstanceId(id);
        Process process = new Process();
        process.setName(event.getProcessInstance().getProcessName());
//        process.setProcessVariables(rfpi.getVariables());

        processTraceEvent.setProcess(process);

        try {
            LOGGER.debug("BeforeProcessStarted sending to queue");
            publisher.publishMessage(processTraceEvent);
        } catch (PublishingFailedException e) {
            e.printStackTrace();
        }
    }

    public void afterProcessCompleted(ProcessCompletedEvent event) {
        LOGGER.trace("AfterProcessCompleted: " + event.toString());
        if(event.getProcessInstance().getParentProcessInstanceId() == -1 ) {
            sendProcessCompletedEvent(event);

            // close the publisher when everything is done
            try {
                LOGGER.debug("Closing process listener publisher");
            } catch (Exception e) {
                LOGGER.warn("Failed to close publisher", e);
            }
        }
    }



    private void sendProcessCompletedEvent(ProcessCompletedEvent event) {
        RuleFlowProcessInstance rfpi = (RuleFlowProcessInstance) event.getProcessInstance();

        String id = Long.toString(rfpi.getId());

        // Send process completed event
        ProcessTraceEvent processTraceEvent = new ProcessTraceEvent();
        processTraceEvent.setEventType(TraceEventType.ProcessTraceEvent);
        processTraceEvent.setTimeStamp(LocalDateTime.now());
        processTraceEvent.setType(ProcessTraceEventType.AfterProcessCompleted);
        processTraceEvent.setProcessInstanceId(id);
        Process process = new Process();
//        process.setProcessVariables(rfpi.getVariables());
        process.setName(event.getProcessInstance().getProcessName());
        processTraceEvent.setProcess(process);

        try {
            LOGGER.debug("BeforeProcessStarted sending to queue");
            publisher.publishMessage(processTraceEvent);
        } catch (PublishingFailedException e) {
            LOGGER.warn("Failed to publish message", e);
//            e.printStackTrace();
        }

    }

    public void beforeProcessCompleted(ProcessCompletedEvent event) {
        LOGGER.trace("BeforeProcessCompleted: " + event.toString());
    }

    public void afterNodeLeft(ProcessNodeLeftEvent event) {
        LOGGER.trace("AfterNodeLeft: " + event.toString());
    }

    public void afterNodeTriggered(ProcessNodeTriggeredEvent event) {
        LOGGER.trace("AfterNodeTriggered: " + event.toString());

        RuleFlowProcessInstance rfpi = (RuleFlowProcessInstance) event.getProcessInstance();

        String id = Long.toString(event.getProcessInstance().getId());

        ProcessTraceEvent processTraceEvent = new ProcessTraceEvent();
        processTraceEvent.setEventType(TraceEventType.ProcessTraceEvent);
        processTraceEvent.setTimeStamp(LocalDateTime.now());
        processTraceEvent.setType(ProcessTraceEventType.NodeTriggered);
        processTraceEvent.setProcessInstanceId(id);

        Node node = new Node();
        node.setState(NodeState.Completed);
        node.setStartedOn(nodeStartTime);
        node.setCompletedOn(LocalDateTime.now());
        node.setID(Long.toString(event.getNodeInstance().getId()));
        node.setName(event.getNodeInstance().getNodeName());
        
        Process process = new Process();
        process.setNode(node);
        process.setName(event.getProcessInstance().getProcessName());
//        process.setProcessVariables(rfpi.getVariables());
        
        processTraceEvent.setProcess(process);
        try {
            publisher.publishMessage(processTraceEvent);
        } catch (PublishingFailedException e) {
            LOGGER.warn("Failed to publish message", e);
//            e.printStackTrace();
        }
    }

    public void afterProcessStarted(ProcessStartedEvent event) {
        LOGGER.trace("AfterProcessStarted: " + event.toString());
    }

    public void afterVariableChanged(ProcessVariableChangedEvent event) {
        LOGGER.trace("AfterVariableChanged: " + event.toString());
    }

    public void beforeNodeLeft(ProcessNodeLeftEvent event) {
        LOGGER.trace("BeforeNodeLeft: " + event.toString());
    }

    public void beforeVariableChanged(ProcessVariableChangedEvent event) {
        LOGGER.trace("BeforeVariableChanged: " + event.toString());
    }

}