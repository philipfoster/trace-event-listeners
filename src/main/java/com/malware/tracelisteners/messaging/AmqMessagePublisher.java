package com.malware.tracelisteners.messaging;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.malware.tracelisteners.events.ProcessTraceEvent;
import javax.jms.Connection;
import javax.jms.ConnectionFactory;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.MessageProducer;
import javax.jms.Session;
import javax.jms.TextMessage;
import javax.naming.InitialContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * This class will publish an event to an AMQ message broker managed in JNDI.
 */
public class AmqMessagePublisher implements MessagePublisher {

    private static final Logger LOGGER = LoggerFactory.getLogger(AmqMessagePublisher.class);
    private final AmqConnectionProvider amqProvider;
    private final ObjectMapper mapper;

    public AmqMessagePublisher() throws Exception {
        mapper = new ObjectMapper();
        amqProvider = new JndiAmqConnectionProvider();

//        LOGGER.info("Initializing JMS connection factory");
//        context = new InitialContext();
//        connectionFactory = (ConnectionFactory) context.lookup(JNDI_CONNECTION_FACTORY);

//        LOGGER.info("Successfully loaded JMS connection factory from JNDI");
    }

    @Override
    public void publishMessage(ProcessTraceEvent event) throws PublishingFailedException {
        LOGGER.debug("Publishing process trace event");
        try {
            Destination dest = amqProvider.getProcessEventQueue();
            publishMessage(dest, event);
        } catch (Exception e) {
            throw new PublishingFailedException("Could not load event queue.", e);
        }
    }

    private void publishMessage(Destination dest, Object event) throws PublishingFailedException {
        try {
            String eventStr = mapper.writeValueAsString(event);
            System.out.println("DEST " + dest.toString() + " event = " + eventStr);
        } catch (JsonProcessingException e) {
            e.printStackTrace();
        }

        try (Connection connection = amqProvider.getConnectionFactory().createConnection()) {
            try (Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE)) {
//                Destination dest = (Destination) context.lookup(destName);
                MessageProducer producer = session.createProducer(dest);

                String eventStr = mapper.writeValueAsString(event);

                TextMessage message = session.createTextMessage(eventStr);
                producer.send(message);
            } catch (Exception e) {
                LOGGER.error("Failed to publish message to queue " + dest.toString(), e);
                throw new PublishingFailedException(e);
            }
        } catch (JMSException e) {
            LOGGER.error("Failed to obtain JMS connection", e);
            throw new PublishingFailedException(e);
        }
    }
}
